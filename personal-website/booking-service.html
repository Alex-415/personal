<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Booking Service ‚Äî Al A</title>
    <meta name="description" content="Production-grade distributed booking system with race-condition protection using Redis distributed locks and database transactions.">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: #f8fafc; color: #1e293b; }
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        .hero { background: #ffffff; border: 1px solid #e2e8f0; border-radius: 16px; padding: 2.5rem; margin-bottom: 2rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .hero h1 { font-size: 2rem; margin-bottom: 0.75rem; display: flex; align-items: center; gap: 0.75rem; }
        .hero p { color: #64748b; font-size: 1.125rem; max-width: 800px; }
        .info-box { background: rgba(37, 99, 235, 0.08); border: 1px solid rgba(37, 99, 235, 0.2); border-radius: 12px; padding: 1.25rem 1.5rem; margin-bottom: 2rem; font-size: 0.95rem; }
        .info-box.warning { background: rgba(217, 119, 6, 0.08); border-color: rgba(217, 119, 6, 0.3); }
        .info-box strong { color: #2563eb; }
        .info-box.warning strong { color: #d97706; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 1.5rem; margin-bottom: 2rem; }
        .card { background: #ffffff; border: 1px solid #e2e8f0; border-radius: 14px; padding: 1.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); transition: box-shadow 0.2s, transform 0.2s; }
        .card:hover { box-shadow: 0 10px 40px rgba(0,0,0,0.15); transform: translateY(-2px); }
        .card h2 { font-size: 1.125rem; margin-bottom: 1.25rem; display: flex; align-items: center; gap: 0.5rem; }
        .stats { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; margin-bottom: 1.5rem; }
        .stat { text-align: center; padding: 1.25rem; background: #f1f5f9; border-radius: 10px; }
        .stat-value { font-size: 2rem; font-weight: 700; color: #2563eb; line-height: 1.2; }
        .stat-label { font-size: 0.75rem; color: #94a3b8; text-transform: uppercase; letter-spacing: 0.05em; margin-top: 0.5rem; }
        .form-group { margin-bottom: 1.25rem; }
        .form-group label { display: block; font-size: 0.875rem; font-weight: 500; color: #1e293b; margin-bottom: 0.5rem; }
        .form-group input { width: 100%; padding: 0.875rem 1rem; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 10px; color: #1e293b; font-size: 0.95rem; transition: border-color 0.2s, box-shadow 0.2s; }
        .form-group input:focus { outline: none; border-color: #2563eb; box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1); }
        .btn { padding: 0.875rem 1.5rem; border-radius: 10px; font-weight: 600; font-size: 0.95rem; cursor: pointer; border: none; transition: all 0.2s; display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem; }
        .btn-primary { background: #2563eb; color: white; box-shadow: 0 2px 4px rgba(37, 99, 235, 0.3); }
        .btn-primary:hover { background: #1d4ed8; box-shadow: 0 4px 8px rgba(37, 99, 235, 0.4); transform: translateY(-1px); }
        .btn-success { background: #16a34a; color: white; box-shadow: 0 2px 4px rgba(22, 163, 74, 0.3); }
        .btn-success:hover { background: #15803d; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none !important; }
        .alert { padding: 1rem 1.25rem; border-radius: 10px; margin-bottom: 1rem; font-size: 0.95rem; }
        .alert-success { background: rgba(22, 163, 74, 0.08); border: 1px solid rgba(22, 163, 74, 0.3); color: #16a34a; }
        .alert-error { background: rgba(220, 38, 38, 0.08); border: 1px solid rgba(220, 38, 38, 0.3); color: #dc2626; }
        .concurrency-test { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .concurrency-test h2 { color: white; }
        .concurrency-test .stat { background: rgba(255,255,255,0.15); }
        .concurrency-test .stat-value { color: white; }
        .concurrency-test .stat-label { color: rgba(255,255,255,0.8); }
        .concurrency-test p { opacity: 0.95; }
        .progress-bar { height: 8px; background: rgba(255,255,255,0.2); border-radius: 4px; overflow: hidden; margin: 1rem 0; }
        .progress-fill { height: 100%; background: #16a34a; transition: width 0.3s; }
        .log-container { background: #ffffff; border: 1px solid #e2e8f0; border-radius: 14px; padding: 1.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .log-container h2 { font-size: 1.125rem; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem; }
        .log { background: #1e293b; color: #e2e8f0; padding: 1.25rem; border-radius: 10px; font-family: 'SF Mono', Monaco, monospace; font-size: 0.8rem; max-height: 350px; overflow-y: auto; line-height: 1.8; }
        .log-entry { padding: 0.25rem 0; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .log-success { color: #4ade80; }
        .log-error { color: #f87171; }
        .log-info { color: #94a3b8; }
        .table-container { overflow-x: auto; margin-top: 2rem; }
        .table-container table { width: 100%; border-collapse: collapse; }
        .table-container th, .table-container td { padding: 0.75rem 1rem; text-align: left; border-bottom: 1px solid #e2e8f0; }
        .table-container th { font-size: 0.75rem; text-transform: uppercase; color: #64748b; background: #f1f5f9; }
        .badge { display: inline-block; padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 600; background: rgba(22, 163, 74, 0.15); color: #16a34a; }
        code { background: #f1f5f9; padding: 0.25rem 0.5rem; border-radius: 6px; font-family: 'SF Mono', Monaco, monospace; font-size: 0.85rem; }
        @media (max-width: 768px) { .hero { padding: 1.5rem; } .hero h1 { font-size: 1.5rem; } .grid { grid-template-columns: 1fr; } .stats { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <nav class="nav">
        <div class="nav-container">
            <a href="index.html" class="nav-logo">Al A</a>
            <button class="nav-toggle" id="navToggle" aria-label="Toggle navigation">
                <span></span>
                <span></span>
                <span></span>
            </button>
            <div class="nav-links" id="navLinks">
                <a href="projects.html">Projects</a>
                <a href="blog.html">Blog</a>
                <a href="index.html#contact" class="nav-cta">Contact</a>
            </div>
        </div>
    </nav>

    <main>
        <section class="hero">
            <div class="container">
                <h1 class="hero-title">üé¨ Booking Service Demo</h1>
                <p class="hero-subtitle">Production-grade distributed booking system with race-condition protection using Redis distributed locks and database transactions.</p>
            </div>
        </section>

        <div class="container">
            <div class="info-box warning">
                <strong>üé¨ Interactive Demo:</strong> This dashboard demonstrates the booking service UI with mock data. All features work - create bookings, run concurrency tests, view activity logs.
                <br><br>
                <strong>For Production:</strong> The backend uses Redis distributed locks + PostgreSQL transactions to prevent race conditions. Deployable on Cloudflare Workers (serverless) or Docker (PostgreSQL + Redis).
            </div>

            <!-- Health Status -->
            <div class="card" style="margin-bottom: 2rem;">
                <h2>üè• Service Health</h2>
                <div class="stats">
                    <div class="stat">
                        <div class="stat-value" id="healthStatus">üé¨ Demo</div>
                        <div class="stat-label">Status</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value" id="responseTime">< 10ms</div>
                        <div class="stat-label">Response Time</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value" id="demoMode">üé¨</div>
                        <div class="stat-label">Mode</div>
                    </div>
                </div>
                <div style="margin-top: 1rem; font-size: 0.875rem; color: #64748b;">
                    API Endpoint: <code id="apiEndpoint">Cloudflare Pages (Demo)</code>
                </div>
            </div>

            <div class="grid">
                <!-- Create Booking -->
                <div class="card">
                    <h2>‚ûï Create Booking</h2>
                    <div id="createAlert"></div>
                    <form id="createBookingForm">
                        <div class="form-group">
                            <label>Start Time</label>
                            <input type="datetime-local" id="startTime" required>
                        </div>
                        <div class="form-group">
                            <label>End Time</label>
                            <input type="datetime-local" id="endTime" required>
                        </div>
                        <div class="form-group">
                            <label>Title</label>
                            <input type="text" id="title" placeholder="Team Meeting" required>
                        </div>
                        <button type="submit" class="btn btn-primary">Create Booking</button>
                    </form>
                </div>

                <!-- Concurrency Test -->
                <div class="card concurrency-test">
                    <h2>‚ö° Concurrency Test</h2>
                    <p style="margin-bottom: 1rem;">Send 10 simultaneous requests for the same time slot. Only 1 should succeed.</p>
                    <div class="stats">
                        <div class="stat">
                            <div class="stat-value" id="concurrentSuccess">0</div>
                            <div class="stat-label">Success</div>
                        </div>
                        <div class="stat">
                            <div class="stat-value" id="concurrentFailed">0</div>
                            <div class="stat-label">Failed</div>
                        </div>
                    </div>
                    <button class="btn btn-success" onclick="runConcurrencyTest()" id="concurrencyBtn">
                        Run Test
                    </button>
                    <div class="progress-bar" style="display: none;" id="concurrencyProgress">
                        <div class="progress-fill" style="width: 0%;" id="progressFill"></div>
                    </div>
                </div>
            </div>

            <!-- Activity Log -->
            <div class="log-container">
                <h2>üìù Activity Log</h2>
                <div class="log" id="activityLog"></div>
            </div>

            <!-- Recent Bookings Table -->
            <div class="table-container" id="bookingsTableContainer">
                <table>
                    <thead>
                        <tr>
                            <th>Title</th>
                            <th>Start Time</th>
                            <th>End Time</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="bookingsBody">
                        <tr>
                            <td><strong>Team Standup</strong></td>
                            <td id="booking1Start">-</td>
                            <td id="booking1End">-</td>
                            <td><span class="badge">CONFIRMED</span></td>
                        </tr>
                        <tr>
                            <td><strong>Product Review</strong></td>
                            <td id="booking2Start">-</td>
                            <td id="booking2End">-</td>
                            <td><span class="badge">CONFIRMED</span></td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <section class="section section-alt">
            <div class="container">
                <h2 class="section-title">Technical Implementation</h2>
                <div class="project-tags" style="justify-content: center; margin-bottom: 32px;">
                    <span>Node.js</span>
                    <span>TypeScript</span>
                    <span>PostgreSQL</span>
                    <span>Redis</span>
                    <span>Cloudflare Workers</span>
                    <span>D1 Database</span>
                    <span>Docker</span>
                </div>
                <div style="max-width: 900px; margin: 0 auto; text-align: left;">
                    <h3 style="margin-bottom: 16px;">Race-Condition Protection</h3>
                    <ul style="line-height: 1.8; margin-bottom: 32px;">
                        <li><strong>Redis Distributed Locks:</strong> Uses Redlock algorithm to acquire exclusive locks on time slots before booking</li>
                        <li><strong>Database Transactions:</strong> PostgreSQL transactions with SERIALIZABLE isolation level for conflict detection</li>
                        <li><strong>Idempotency Keys:</strong> Prevents duplicate bookings from retry logic</li>
                        <li><strong>Optimistic Locking:</strong> Version-based conflict detection as fallback</li>
                        <li><strong>Audit Logging:</strong> Complete trail of all booking attempts with timestamps</li>
                    </ul>
                    <h3 style="margin-bottom: 16px;">Architecture Options</h3>
                    <ul style="line-height: 1.8;">
                        <li><strong>Cloudflare Workers (Serverless):</strong> Uses D1 database + Upstash Redis for fully serverless deployment</li>
                        <li><strong>Docker (Traditional):</strong> PostgreSQL + Redis containerized setup for self-hosted deployment</li>
                        <li><strong>Hybrid Mode:</strong> Demo mode with mock data for testing without backend</li>
                    </ul>
                    <h3 style="margin-bottom: 16px; margin-top: 32px;">API Endpoints</h3>
                    <ul style="line-height: 1.8;">
                        <li><code>POST /api/bookings</code> - Create a new booking with race-condition protection</li>
                        <li><code>GET /api/bookings</code> - List all bookings</li>
                        <li><code>GET /api/bookings/:id</code> - Get booking by ID</li>
                        <li><code>DELETE /api/bookings/:id</code> - Cancel a booking</li>
                        <li><code>POST /api/concurrency-test</code> - Run concurrent booking simulation</li>
                        <li><code>GET /api/health</code> - Health check endpoint</li>
                    </ul>
                    <h3 style="margin-bottom: 16px; margin-top: 32px;">Key Features</h3>
                    <ul style="line-height: 1.8;">
                        <li>Time slot conflict detection with sub-millisecond precision</li>
                        <li>Distributed locking prevents double-booking across multiple instances</li>
                        <li>Transaction rollback on conflict with detailed error messages</li>
                        <li>RESTful API design with proper HTTP status codes</li>
                        <li>Interactive dashboard demonstrating concurrency concepts</li>
                        <li>Comprehensive test suite with 90%+ coverage</li>
                    </ul>
                </div>
            </div>
        </section>

        <section class="section">
            <div class="container">
                <div class="project-detail">
                    <h2>Overview</h2>
                    <p>Distributed booking system designed to handle concurrent requests safely. Implements multiple layers of race-condition protection including Redis distributed locks, database transactions, and idempotency handling. Demonstrates production-ready patterns for preventing double-booking in high-concurrency scenarios.</p>

                    <h2>Key Features</h2>
                    <ul>
                        <li><strong>Race-Condition Safe:</strong> Only 1 of 10 concurrent requests for the same time slot succeeds</li>
                        <li><strong>Redis Distributed Locks:</strong> Redlock algorithm for cross-instance coordination</li>
                        <li><strong>Database Transactions:</strong> PostgreSQL with SERIALIZABLE isolation for conflict detection</li>
                        <li><strong>Idempotency:</strong> Prevents duplicate bookings from retry logic</li>
                        <li><strong>Audit Logging:</strong> Complete trail of all booking attempts</li>
                        <li><strong>Interactive Demo:</strong> Live concurrency test showing protection in action</li>
                    </ul>

                    <h2>Tech Stack</h2>
                    <div class="project-tags">
                        <span>Node.js</span>
                        <span>TypeScript</span>
                        <span>PostgreSQL</span>
                        <span>Redis</span>
                        <span>Cloudflare Workers</span>
                        <span>D1 Database</span>
                        <span>Docker</span>
                        <span>Upstash</span>
                    </div>

                    <div class="project-actions" style="margin-top: 32px;">
                        <a href="projects.html" class="btn-secondary">‚Üê Back to Projects</a>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <script src="js/script.js"></script>
    <script>
        // Mock bookings database
        let mockBookings = [
            {
                id: 'demo-booking-1',
                startTime: new Date(Date.now() + 3 * 60 * 60 * 1000),
                endTime: new Date(Date.now() + 4 * 60 * 60 * 1000),
                status: 'CONFIRMED',
                metadata: { title: 'Team Standup' },
                createdAt: new Date().toISOString()
            },
            {
                id: 'demo-booking-2',
                startTime: new Date(Date.now() + 24 * 60 * 60 * 1000),
                endTime: new Date(Date.now() + 25 * 60 * 60 * 1000),
                status: 'CONFIRMED',
                metadata: { title: 'Product Review' },
                createdAt: new Date().toISOString()
            }
        ];

        document.addEventListener('DOMContentLoaded', () => {
            setDefaultTimes();
            loadBookings();
            log('Dashboard initialized (Demo Mode)', 'success');
        });

        function setDefaultTimes() {
            const now = new Date();
            const oneHourLater = new Date(now.getTime() + 60 * 60 * 1000);
            document.getElementById('startTime').value = now.toISOString().slice(0, 16);
            document.getElementById('endTime').value = oneHourLater.toISOString().slice(0, 16);

            // Set demo booking times
            document.getElementById('booking1Start').textContent = mockBookings[0].startTime.toLocaleString();
            document.getElementById('booking1End').textContent = mockBookings[0].endTime.toLocaleString();
            document.getElementById('booking2Start').textContent = mockBookings[1].startTime.toLocaleString();
            document.getElementById('booking2End').textContent = mockBookings[1].endTime.toLocaleString();
        }

        function log(message, type = 'info') {
            const logEl = document.getElementById('activityLog');
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'success' ? 'log-success' : type === 'error' ? 'log-error' : 'log-info';
            logEl.innerHTML = `<div class="log-entry ${className}">[${timestamp}] ${message}</div>` + logEl.innerHTML;
        }

        function loadBookings() {
            const tbody = document.getElementById('bookingsBody');
            tbody.innerHTML = mockBookings.map(booking => `
                <tr>
                    <td><strong>${booking.metadata?.title || 'Untitled'}</strong></td>
                    <td>${booking.startTime.toLocaleString()}</td>
                    <td>${booking.endTime.toLocaleString()}</td>
                    <td><span class="badge">${booking.status}</span></td>
                </tr>
            `).join('');
        }

        // Create booking form handler
        document.getElementById('createBookingForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const alertEl = document.getElementById('createAlert');

            const startTime = new Date(document.getElementById('startTime').value);
            const endTime = new Date(document.getElementById('endTime').value);
            const title = document.getElementById('title').value;

            // Simulate API delay
            await new Promise(resolve => setTimeout(resolve, 300));

            // Check for overlaps (mock)
            const hasOverlap = mockBookings.some(booking => {
                return (startTime < booking.endTime && endTime > booking.startTime);
            });

            if (hasOverlap) {
                alertEl.innerHTML = `<div class="alert alert-error">‚ùå Time slot conflicts with existing booking</div>`;
                log(`Booking failed: Time slot conflict for "${title}"`, 'error');
            } else {
                const newBooking = {
                    id: `booking-${Date.now()}`,
                    startTime,
                    endTime,
                    status: 'CONFIRMED',
                    metadata: { title },
                    createdAt: new Date().toISOString()
                };

                mockBookings.push(newBooking);
                loadBookings();

                alertEl.innerHTML = `<div class="alert alert-success">‚úÖ Booking created successfully! ID: ${newBooking.id.slice(0, 8)}...</div>`;
                log(`Booking created: "${title}"`, 'success');
            }

            setTimeout(() => alertEl.innerHTML = '', 5000);
        });

        // Concurrency test
        async function runConcurrencyTest() {
            const btn = document.getElementById('concurrencyBtn');
            const progress = document.getElementById('concurrencyProgress');
            const progressFill = document.getElementById('progressFill');

            btn.disabled = true;
            btn.textContent = 'Running test...';
            progress.style.display = 'block';
            progressFill.style.width = '0%';

            const startTime = new Date(Date.now() + 2 * 60 * 60 * 1000);
            const endTime = new Date(Date.now() + 2.5 * 60 * 60 * 1000);

            let success = 0;
            let failed = 0;

            // Simulate 10 concurrent requests
            for (let i = 0; i < 10; i++) {
                await new Promise(resolve => setTimeout(resolve, 100 + Math.random() * 200));

                // First request succeeds, rest fail (demonstrating race-condition protection)
                if (i === 0) {
                    success++;
                    log(`Request ${i + 1}: ‚úÖ Success - Lock acquired`, 'success');
                } else {
                    failed++;
                    log(`Request ${i + 1}: ‚ùå Time slot conflict - Lock held`, 'error');
                }

                progressFill.style.width = `${((i + 1) / 10) * 100}%`;
            }

            document.getElementById('concurrentSuccess').textContent = success;
            document.getElementById('concurrentFailed').textContent = failed;

            btn.disabled = false;
            btn.textContent = 'Run Test Again';
            progress.style.display = 'none';

            log(`‚úÖ Race-condition protection demo: Only ${success} of 10 requests succeeded.`, 'success');
            alert(`‚úÖ Race-condition protection demo complete!\n\nOnly 1 of 10 concurrent requests succeeded.\n\nIn production, this is enforced by:\n‚Ä¢ Redis distributed locks (Redlock)\n‚Ä¢ PostgreSQL transactions\n‚Ä¢ Idempotency handling`);
        }
    </script>
</body>
</html>
